<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>OpenCV Edge Detection</title>
  <!-- OpenCV.js を同期で読み込む -->
  <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>
<body>

<input type="file" id="imageInput" accept="image/*">
<canvas id="canvas"></canvas>

<script>
  let binaryData = [];

  // OpenCV.js が完全にロードされたら実行される
  cv['onRuntimeInitialized'] = () => {
    console.log('OpenCV.js is ready.');

    document.getElementById('imageInput').addEventListener('change', handleImageUpload);
  };

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = () => processImage(img);
    img.src = URL.createObjectURL(file);
  }

  function processImage(img) {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    // OpenCV処理
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    let edges = new cv.Mat();

    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
    cv.Canny(gray, edges, 100, 200);

    cv.imshow('canvas', edges);

    binaryData = [];
    for (let y = 0; y < edges.rows; y++) {
      for (let x = 0; x < edges.cols; x++) {
        const val = edges.ucharPtr(y, x)[0];
        binaryData.push(val > 0 ? 1 : 0);
      }
    }

    src.delete(); gray.delete(); edges.delete();

    console.log('二値化配列の長さ:', binaryData.length);
  }
</script>

</body>
</html>